<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kesin √á√∂z√ºm: Ses -> Video</title>
    <style>
        body { background: #121212; color: #eee; font-family: monospace; text-align: center; padding: 20px; }
        .box { border: 2px solid #333; padding: 20px; max-width: 600px; margin: 0 auto; border-radius: 8px; background: #1e1e1e; }
        button { background: #d32f2f; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 5px; margin-top: 15px; font-weight: bold; width: 100%; }
        button:disabled { background: #555; cursor: wait; }
        button:hover:not(:disabled) { background: #b71c1c; }
        #log { text-align: left; background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: scroll; border: 1px solid #444; margin-top: 15px; font-size: 0.8rem; }
        video { width: 100%; margin-top: 20px; border: 2px solid #333; display: none; }
        a.download { display: block; margin-top: 15px; background: #1976d2; color: white; padding: 10px; text-decoration: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="box">
        <h1>SON VE KESƒ∞N √á√ñZ√úM</h1>
        <p>ASM.JS Teknolojisi (Header/WASM Derdi Yok)</p>

        <input type="file" id="uploader" accept="audio/*">
        <br>
        <button id="btn" onclick="startProcess()">Vƒ∞DEO OLU≈ûTUR</button>

        <div id="log">Sistem hazƒ±r. Dosya se√ßiniz.</div>
        
        <video id="outputVideo" controls></video>
        <div id="downloadArea"></div>
    </div>

    <script>
        const WORKER_URL = "https://cdn.jsdelivr.net/npm/ffmpeg.js@4.2.9003/ffmpeg-worker-mp4.js";
        
        let worker;
        const logDiv = document.getElementById('log');
        const btn = document.getElementById('btn');
        const videoEl = document.getElementById('outputVideo');
        const dlArea = document.getElementById('downloadArea');

        function log(msg) {
            logDiv.innerHTML += `> ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function initWorker() {
            if (worker) return;
            log("Motor indiriliyor (ASM.js - Biraz s√ºrebilir)...");
            
            worker = new Worker(WORKER_URL);

            worker.onmessage = function(e) {
                const msg = e.data;
                if (msg.type === "ready") {
                    log("‚úÖ MOTOR HAZIR! (Hata yok, tertemiz)");
                    btn.disabled = false;
                } 
                else if (msg.type === "stdout") {
                    log(msg.data);
                } 
                else if (msg.type === "stderr") {
                    console.log(msg.data); 
                } 
                else if (msg.type === "done") {
                    try {
                        const data = msg.data;
                        if (data.MEMFS && data.MEMFS.length > 0) {
                            const out = data.MEMFS[0];
                            if (out) {
                                log("‚úÖ Vƒ∞DEO OLU≈ûTURULDU!");
                                const blob = new Blob([out.data], { type: "video/mp4" });
                                const url = URL.createObjectURL(blob);
                                
                                videoEl.src = url;
                                videoEl.style.display = "block";
                                
                                dlArea.innerHTML = `<a href="${url}" download="video.mp4" class="download">üì• Vƒ∞DEOYU ƒ∞NDƒ∞R</a>`;
                            }
                        } else {
                            log("‚ùå HATA: √áƒ±ktƒ± dosyasƒ± bo≈ü.");
                        }
                    } catch (err) {
                        log("‚ùå ƒ∞≈ûLEME HATASI: " + err);
                    } finally {
                        btn.disabled = false;
                        btn.innerText = "TEKRAR YAP";
                    }
                }
            };
            
            worker.onerror = function(e) {
                log("‚ùå WORKER HATASI: " + e.message);
                btn.disabled = false;
            };
        }

        function startProcess() {
            const fileInput = document.getElementById('uploader');
            if (fileInput.files.length === 0) {
                alert("L√ºtfen bir ses dosyasƒ± se√ßin!");
                return;
            }

            const file = fileInput.files[0];
            btn.disabled = true;
            btn.innerText = "ƒ∞≈ûLENƒ∞YOR...";
            log("Dosya okunuyor...");
            
            if (!worker) {
                initWorker();
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                log("Dosya belleƒüe alƒ±ndƒ±. FFmpeg ba≈ülatƒ±lƒ±yor...");
                const args = [
                    "-f", "lavfi", "-i", "color=c=black:s=1080x1920:r=30",
                    "-i", "input.mp3",
                    "-c:v", "libx264", 
                    "-preset", "ultrafast", 
                    "-tune", "stillimage",
                    "-c:a", "aac", 
                    "-pix_fmt", "yuv420p", 
                    "-shortest", 
                    "output.mp4"
                ];
                
                checkWorkerAndRun(data, args);
            };
            reader.readAsArrayBuffer(file);
        }

        function checkWorkerAndRun(fileData, args) {
            if (!worker) {
                 worker = new Worker(WORKER_URL);
                 setupWorkerHandler();
            }
            
            log("Komut g√∂nderiliyor...");
            
            worker.postMessage({
                type: "run",
                arguments: args,
                MEMFS: [
                    { name: "input.mp3", data: fileData }
                ]
            });
        }
        
        initWorker();

    </script>
</body>
</html>
