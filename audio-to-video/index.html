<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Video Converter (Blob Fix)</title>
    <style>
        body { background: #121212; color: #eee; font-family: monospace; text-align: center; padding: 20px; }
        .box { border: 2px solid #333; padding: 20px; max-width: 600px; margin: 0 auto; border-radius: 8px; background: #1e1e1e; }
        button { background: #d32f2f; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 5px; margin-top: 15px; font-weight: bold; width: 100%; }
        button:disabled { background: #555; cursor: wait; }
        #log { text-align: left; background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: scroll; border: 1px solid #444; margin-top: 15px; font-size: 0.8rem; }
        video { width: 100%; margin-top: 20px; border: 2px solid #333; display: none; }
        a.download { display: block; margin-top: 15px; background: #1976d2; color: white; padding: 10px; text-decoration: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="box">
        <h1>BLOB HACK CONVERTER</h1>
        <p>CORS HatasÄ± Fixlendi</p>

        <input type="file" id="uploader" accept="audio/*">
        <br>
        <button id="btn" onclick="startProcess()">VÄ°DEO OLUÅžTUR</button>

        <div id="log">Sistem hazÄ±r.</div>
        
        <video id="outputVideo" controls></video>
        <div id="downloadArea"></div>
    </div>

    <script>
        const WORKER_URL = "https://cdn.jsdelivr.net/npm/ffmpeg.js@4.2.9003/ffmpeg-worker-mp4.js";
        
        let worker;
        const logDiv = document.getElementById('log');
        const btn = document.getElementById('btn');
        const videoEl = document.getElementById('outputVideo');
        const dlArea = document.getElementById('downloadArea');

        function log(msg) {
            logDiv.innerHTML += `> ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function createWorkerFromUrl(url) {
            log("Motor dosyasÄ± indiriliyor...");
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Worker dosyasÄ± indirilemedi!");
                const scriptContent = await response.text();

                const blob = new Blob([scriptContent], { type: 'application/javascript' });
                
                const blobUrl = URL.createObjectURL(blob);
                
                log("âœ… Motor hafÄ±zaya alÄ±ndÄ±.");
                return new Worker(blobUrl);

            } catch (e) {
                log("âŒ Ä°NDÄ°RME HATASI: " + e.message);
                throw e;
            }
        }

        async function initWorker() {
            if (worker) return;

            try {
                worker = await createWorkerFromUrl(WORKER_URL);

                worker.onmessage = function(e) {
                    const msg = e.data;
                    if (msg.type === "ready") {
                        log("âœ… MOTOR HAZIR!");
                        btn.disabled = false;
                    } 
                    else if (msg.type === "stdout") { log(msg.data); } 
                    else if (msg.type === "stderr") { console.log(msg.data); } 
                    else if (msg.type === "done") {
                        try {
                            const data = msg.data;
                            if (data.MEMFS && data.MEMFS.length > 0) {
                                const out = data.MEMFS[0];
                                log("âœ… VÄ°DEO OLUÅžTURULDU!");
                                const blob = new Blob([out.data], { type: "video/mp4" });
                                const url = URL.createObjectURL(blob);
                                videoEl.src = url;
                                videoEl.style.display = "block";
                                dlArea.innerHTML = `<a href="${url}" download="video.mp4" class="download">ðŸ“¥ Ä°NDÄ°R</a>`;
                            } else {
                                log("âŒ HATA: Ã‡Ä±ktÄ± boÅŸ.");
                            }
                        } catch (err) {
                            log("âŒ HATA: " + err);
                        } finally {
                            btn.disabled = false;
                            btn.innerText = "TEKRAR YAP";
                        }
                    }
                };
            } catch (e) {
                log("Worker BaÅŸlatÄ±lamadÄ±: " + e);
            }
        }

        function startProcess() {
            const fileInput = document.getElementById('uploader');
            if (fileInput.files.length === 0) { alert("Dosya seÃ§!"); return; }

            const file = fileInput.files[0];
            btn.disabled = true;
            btn.innerText = "Ä°ÅžLENÄ°YOR...";
            log("Dosya okunuyor...");
            
            if (!worker) {
                initWorker().then(() => {
                    readFileAndRun(file);
                });
            } else {
                readFileAndRun(file);
            }
        }

        function readFileAndRun(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                
                const args = [
                    "-f", "lavfi", "-i", "color=c=black:s=1080x1920:r=30",
                    "-i", "input.mp3",
                    "-c:v", "libx264", 
                    "-preset", "ultrafast", 
                    "-tune", "stillimage",
                    "-c:a", "aac", 
                    "-pix_fmt", "yuv420p", 
                    "-shortest", 
                    "output.mp4"
                ];

                waitForWorkerAndPost(data, args);
            };
            reader.readAsArrayBuffer(file);
        }

        function waitForWorkerAndPost(data, args) {
            if(worker) {
                worker.postMessage({
                    type: "run",
                    arguments: args,
                    MEMFS: [{ name: "input.mp3", data: data }]
                });
            } else {
                setTimeout(() => waitForWorkerAndPost(data, args), 100);
            }
        }
        
        initWorker();

    </script>
</body>
</html>
