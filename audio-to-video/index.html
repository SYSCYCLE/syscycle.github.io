<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages Video Maker (Legacy Fix)</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.1/dist/ffmpeg.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; text-align: center; }
        .box { border: 2px solid #333; padding: 20px; max-width: 500px; margin: 0 auto; border-radius: 10px; }
        button { background: #00897b; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-size: 1.2rem; margin-top: 10px; font-weight: bold; }
        button:disabled { background: #333; cursor: wait; }
        #log { text-align: left; background: #111; padding: 10px; height: 150px; overflow-y: scroll; border: 1px solid #444; margin-top: 10px; color: #0f0; }
        video { width: 100%; margin-top: 20px; border: 1px solid #444; }
    </style>
</head>
<body>

    <div class="box">
        <h1>SON Ã‡ARE CONVERTER</h1>
        <p>SharedArrayBuffer HatasÄ± Vermeyen Versiyon</p>

        <input type="file" id="uploader" accept="audio/*">
        <button id="btn" onclick="run()">VÄ°DEO YAP</button>
        
        <div id="log">HazÄ±r. Dosya seÃ§ ve butona bas.</div>
        
        <video id="output" controls></video>
        <br><br>
        <a id="dl" style="display:none; color: yellow; font-size: 1.2rem;">ðŸ“¥ Ä°NDÄ°R</a>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;

        const ffmpeg = createFFmpeg({ 
            log: true,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.8.5/dist/ffmpeg-core.js'
        });

        const logDiv = document.getElementById('log');
        const btn = document.getElementById('btn');

        function logger(msg) {
            logDiv.innerHTML += `> ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function load() {
            try {
                logger("Motor yÃ¼kleniyor (Eski versiyon)...");
                await ffmpeg.load();
                logger("âœ… Motor HazÄ±r! SharedArrayBuffer derdi yok.");
            } catch(e) {
                logger("HATA: " + e.message);
            }
        }
        
        load();

        async function run() {
            const files = document.getElementById('uploader').files;
            if(!files.length) { alert("Dosya yok!"); return; }
            
            btn.disabled = true;
            btn.innerText = "Ä°ÅžLENÄ°YOR...";
            logger("Dosya okunuyor...");

            try {
                const file = files[0];
                ffmpeg.FS('writeFile', 'input.mp3', await fetchFile(file));

                logger("Video iÅŸleniyor... (Bu versiyon biraz yavaÅŸtÄ±r, sabret)");

                await ffmpeg.run(
                    '-f', 'lavfi', '-i', 'color=c=black:s=1080x1920:r=30',
                    '-i', 'input.mp3',
                    '-c:v', 'libx264', 
                    '-preset', 'ultrafast',
                    '-tune', 'stillimage',
                    '-c:a', 'aac', 
                    '-pix_fmt', 'yuv420p', 
                    '-shortest', 
                    'output.mp4'
                );

                logger("âœ… BÄ°TTÄ°! Video aÅŸaÄŸÄ±da.");
                
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                const vid = document.getElementById('output');
                vid.src = url;
                
                const dl = document.getElementById('dl');
                dl.href = url;
                dl.download = "final_video.mp4";
                dl.style.display = "block";

            } catch(e) {
                logger("ðŸ’¥ HATA: " + e.message);
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = "TEKRAR YAP";
            }
        }
    </script>
</body>
</html>
