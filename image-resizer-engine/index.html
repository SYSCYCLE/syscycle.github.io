<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Dynamic Image Resizer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f4f7f6; }
        .controls { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; width: 400px; }
        .input-group { display: flex; justify-content: space-between; align-items: center; }
        input[type="number"] { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        canvas { margin-top: 20px; border: 2px solid #333; max-width: 100%; box-shadow: 0 5px 20px rgba(0,0,0,0.2); background-color: #e5e5e5; /* Şeffaflığı görmek için arka plan */
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
    </style>
</head>
<body>

    <h2>WASM Dynamic Viewer</h2>
    
    <div class="controls">
        <div class="input-group">
            <label>Select an image:</label>
            <input type="file" id="upload" accept="image/*">
        </div>
        <div class="input-group">
            <label>Target Width (W):</label>
            <input type="number" id="targetW" value="720">
        </div>
        <div class="input-group">
            <label>Target Height (H):</label>
            <input type="number" id="targetH" value="1280">
        </div>
        <button id="processBtn" disabled>Resize and Fit Image</button>
    </div>

    <canvas id="outputCanvas"></canvas>

    <script>
        const wasmCode = new Uint8Array([
            0, 97, 115, 109, 1, 0, 0, 0, 1, 10, 1, 96, 6, 127, 127, 127, 127, 127, 127, 0, 3, 2, 1, 0, 5, 4, 1, 0, 128, 2, 7, 29, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 16, 102, 105, 116, 95, 119, 105, 116, 104, 95, 112, 97, 100, 100, 105, 110, 103, 0, 0, 10, 227, 1, 1, 224, 1, 2, 1, 125, 12, 127, 32, 3, 33, 17, 32, 3, 32, 4, 32, 5, 108, 65, 4, 108, 106, 33, 18, 3, 64, 32, 17, 65, 0, 54, 2, 0, 32, 17, 65, 4, 106, 33, 17, 32, 17, 32, 18, 73, 13, 0, 11, 32, 4, 178, 32, 1, 178, 149, 32, 5, 178, 32, 2, 178, 149, 150, 33, 6, 32, 1, 178, 32, 6, 148, 168, 33, 7, 32, 2, 178, 32, 6, 148, 168, 33, 8, 32, 4, 32, 7, 107, 65, 2, 109, 33, 9, 32, 5, 32, 8, 107, 65, 2, 109, 33, 10, 65, 0, 33, 12, 3, 64, 65, 0, 33, 11, 3, 64, 32, 11, 178, 32, 6, 149, 168, 33, 13, 32, 12, 178, 32, 6, 149, 168, 33, 14, 32, 13, 32, 1, 72, 32, 14, 32, 2, 72, 113, 4, 64, 32, 3, 32, 12, 32, 10, 106, 32, 4, 108, 32, 11, 32, 9, 106, 106, 65, 4, 108, 106, 33, 15, 32, 0, 32, 14, 32, 1, 108, 32, 13, 106, 65, 4, 108, 106, 33, 16, 32, 15, 32, 16, 40, 2, 0, 54, 2, 0, 11, 32, 11, 65, 1, 106, 33, 11, 32, 11, 32, 7, 72, 13, 0, 11, 32, 12, 65, 1, 106, 33, 12, 32, 12, 32, 8, 72, 13, 0, 11, 11, 0, 161, 1, 4, 110, 97, 109, 101, 1, 19, 1, 0, 16, 102, 105, 116, 95, 119, 105, 116, 104, 95, 112, 97, 100, 100, 105, 110, 103, 2, 132, 1, 1, 0, 19, 0, 7, 115, 114, 99, 95, 112, 116, 114, 1, 4, 115, 114, 99, 87, 2, 4, 115, 114, 99, 72, 3, 7, 100, 115, 116, 95, 112, 116, 114, 4, 4, 100, 115, 116, 87, 5, 4, 100, 115, 116, 72, 6, 5, 115, 99, 97, 108, 101, 7, 4, 110, 101, 119, 87, 8, 4, 110, 101, 119, 72, 9, 4, 111, 102, 102, 88, 10, 4, 111, 102, 102, 89, 11, 1, 120, 12, 1, 121, 13, 4, 115, 114, 99, 88, 14, 4, 115, 114, 99, 89, 15, 6, 100, 115, 116, 73, 100, 120, 16, 6, 115, 114, 99, 73, 100, 120, 17, 9, 99, 108, 101, 97, 114, 95, 112, 116, 114, 18, 9, 99, 108, 101, 97, 114, 95, 101, 110, 100
        ]);

        let wasmInstance;

        WebAssembly.instantiate(wasmCode).then(result => {
            wasmInstance = result.instance;
            document.getElementById('processBtn').disabled = false;
        });

        document.getElementById('processBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('upload');
            const targetW = parseInt(document.getElementById('targetW').value);
            const targetH = parseInt(document.getElementById('targetH').value);

            if (fileInput.files.length === 0) return alert("Resim seçin.");

            const img = new Image();
            img.src = URL.createObjectURL(fileInput.files[0]);

            img.onload = () => {
                const srcW = img.width;
                const srcH = img.height;
                const offscreen = document.createElement('canvas');
                offscreen.width = srcW; offscreen.height = srcH;
                const ctx = offscreen.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imgData = ctx.getImageData(0, 0, srcW, srcH);
                const srcSize = srcW * srcH * 4;
                const dstSize = targetW * targetH * 4;
                const totalRequired = srcSize + dstSize;
                const currentPages = wasmInstance.exports.memory.buffer.byteLength / 65536;
                const requiredPages = Math.ceil(totalRequired / 65536) + 1;
                if (requiredPages > currentPages) {
                    wasmInstance.exports.memory.grow(requiredPages - currentPages);
                }

                const memory = new Uint8Array(wasmInstance.exports.memory.buffer);
                const srcPtr = 0;
                const dstPtr = srcSize;
                memory.set(imgData.data, srcPtr);
                wasmInstance.exports.fit_with_padding(srcPtr, srcW, srcH, dstPtr, targetW, targetH);
                const resultArray = new Uint8ClampedArray(wasmInstance.exports.memory.buffer, dstPtr, dstSize);
                const outCanvas = document.getElementById('outputCanvas');
                outCanvas.width = targetW;
                outCanvas.height = targetH;
                const outCtx = outCanvas.getContext('2d');
                outCtx.putImageData(new ImageData(resultArray, targetW, targetH), 0, 0);
            };
        });
    </script>
</body>
</html>
